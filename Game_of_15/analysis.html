<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Analysis</title>
    <style>
        :root { --bg: #0f172a; --panel-bg: #1e293b; --text: #f1f5f9; --accent: #38bdf8; --num-player: #3b82f6; --num-bot: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; margin: 0; box-sizing: border-box; }
        
        .sidebar { width: 250px; background: #020617; border-right: 1px solid #334155; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;}
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; overflow-y: auto; }
        
        /* The Secret Theory Section */
        .theory-box {
            width: 90%; max-width: 700px; background: rgba(56, 189, 248, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 15px; margin-bottom: 30px; margin-top: 10px;
        }
        .theory-title { color: var(--accent); font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; }
        .theory-text { font-size: 0.95rem; line-height: 1.5; color: #cbd5e1; }
        .theory-link { color: #f59e0b; font-weight: bold; text-decoration: none; }
        
        /* Game List Buttons */
        .game-item { padding: 15px; background: var(--panel-bg); border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .game-item:hover { background: #334155; }
        .game-item.selected { border-color: var(--accent); background: #1e293b; }
        .game-item h4 { margin: 0 0 5px 0; color: var(--accent); }
        .game-item p { margin: 0; font-size: 0.9rem; color: #94a3b8; }

        /* Replay Area */
        .replay-container { display: flex; gap: 40px; align-items: flex-start; justify-content: center; width: 100%; flex-wrap: wrap; }
        .board-visual { width: 300px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        
        .block-viz { 
            height: 90px; background: #334155; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-weight: bold; position: relative; transition: all 0.3s;
        }
        .block-viz span.num { font-size: 2rem; color: white; }
        .block-viz span.magic { font-size: 0.8rem; color: #64748b; margin-top: 5px; } 
        
        .block-viz.P { background: var(--num-player); border: 2px solid #60a5fa; transform: scale(1.05); z-index: 2; }
        .block-viz.B { background: var(--num-bot); border: 2px solid #f87171; transform: scale(1.05); z-index: 2; }
        
        /* Commentary Box */
        .commentary-box { width: 100%; max-width: 350px; height: 320px; background: var(--panel-bg); border-radius: 12px; padding: 20px; border: 1px solid #475569; display: flex; flex-direction: column; box-sizing: border-box; }
        .comm-header { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .comm-text { font-size: 1rem; line-height: 1.6; color: #cbd5e1; flex: 1; overflow-y: auto; }
        
        /* Controls */
        .control-bar { display: flex; gap: 10px; margin-top: 20px; }
        button { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-next { background: var(--accent); color: #0f172a; }
        .btn-back { background: #334155; color: white; }

        .back-link { margin-bottom: 10px; align-self: flex-end; color: var(--text); text-decoration: none; font-weight: bold; border: 1px solid #334155; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; }
        .back-link:hover { background: #334155; }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 850px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: 150px; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid #334155; padding: 10px; }
            .game-item { min-width: 140px; }
            .replay-container { flex-direction: column-reverse; align-items: center; }
            .board-visual { width: 280px; }
            .block-viz { height: 80px; }
            .commentary-box { width: 100%; max-width: 90%; height: 250px; }
        }
    </style>
</head>
<body>

    <div class="sidebar" id="game-list">
        <h3 style="color:white; margin:0 0 10px 0; width:100%;">Game History</h3>
        </div>

    <div class="main-content">
        <a href="index.html" class="back-link">← Back to Game</a>

        <div class="theory-box">
            <div class="theory-title">The Secret: Disguised Tic-Tac-Toe</div>
            <div class="theory-text">
                "It's exactly the same as Tic-Tac-Toe. If you map the numbers 1-9 into a Magic Square (where every row, column, and diagonal sums to 15), picking a number is just placing an X or O on that square." <br>
                — <a href="https://www.youtube.com/watch?v=UafhPUOCM1E" target="_blank" class="theory-link">Numberphile</a>
            </div>
        </div>
        
        <div class="replay-container">
            <div class="board-visual" id="viz-board"></div>

            <div class="commentary-box">
                <div class="comm-header">Logic Analysis</div>
                <div class="comm-text" id="comm-text">Select a game to begin analysis.</div>
            </div>
        </div>

        <div class="control-bar">
            <button class="btn-back" onclick="resetReplay()">Reset</button>
            <button class="btn-next" onclick="nextStep()" id="btn-next">Next Move ▶</button>
        </div>
    </div>

<script>
    const MAGIC_GRID = [
        { val: 2, pos: "Top Left" }, { val: 7, pos: "Top Mid" }, { val: 6, pos: "Top Right" },
        { val: 9, pos: "Mid Left" }, { val: 5, pos: "Center" }, { val: 1, pos: "Mid Right" },
        { val: 4, pos: "Bot Left" }, { val: 3, pos: "Bot Mid" }, { val: 8, pos: "Bot Right" }
    ];

    let historyData = [];
    let currentGame = null;
    let stepIndex = 0;
    
    let pMoves = [];
    let bMoves = [];
    let available = [1,2,3,4,5,6,7,8,9];

    window.onload = function() {
        const stored = sessionStorage.getItem('gameHistory');
        if(!stored) {
            document.getElementById('comm-text').textContent = "No games played yet. Go back and play at least 5 games!";
            return;
        }
        historyData = JSON.parse(stored);
        renderSidebar();
        initVisualBoard();
    };

    function initVisualBoard() {
        const board = document.getElementById('viz-board');
        board.innerHTML = '';
        MAGIC_GRID.forEach((cell, idx) => {
            const div = document.createElement('div');
            div.className = 'block-viz';
            div.id = `cell-${cell.val}`;
            div.innerHTML = `<span class="num">${cell.val}</span><span class="magic">${cell.pos}</span>`;
            board.appendChild(div);
        });
    }

    function renderSidebar() {
        const list = document.getElementById('game-list');
        // Clear existing items but keep header
        while(list.children.length > 1) { list.removeChild(list.lastChild); }
        
        historyData.forEach((game, idx) => {
            const item = document.createElement('div');
            item.className = 'game-item';
            item.innerHTML = `<h4>Game ${game.id}</h4><p>Winner: ${game.winner}</p>`;
            item.onclick = () => loadGame(idx);
            list.appendChild(item);
        });
    }

    function loadGame(idx) {
        document.querySelectorAll('.game-item').forEach(el => el.classList.remove('selected'));
        // Adjust index because of the header in sidebar
        const items = document.querySelectorAll('.game-item');
        if(items[idx]) items[idx].classList.add('selected');

        currentGame = historyData[idx];
        resetReplay();
        document.getElementById('comm-text').innerHTML = `<strong>Game Loaded.</strong><br>Mode: ${currentGame.mode}<br>Moves: ${currentGame.moves.length}<br><br>Click "Next Move" to see the logic.`;
    }

    function resetReplay() {
        stepIndex = 0;
        pMoves = []; bMoves = [];
        available = [1,2,3,4,5,6,7,8,9];
        document.querySelectorAll('.block-viz').forEach(el => el.className = 'block-viz');
        document.getElementById('btn-next').disabled = false;
        document.getElementById('btn-next').style.opacity = "1";
    }

    function nextStep() {
        if (!currentGame || stepIndex >= currentGame.moves.length) return;

        const move = currentGame.moves[stepIndex];
        const isPlayer = move.who === 'P';
        
        if (isPlayer) pMoves.push(move.num); else bMoves.push(move.num);
        available = available.filter(n => n !== move.num);

        const cell = document.getElementById(`cell-${move.num}`);
        if(cell) cell.classList.add(isPlayer ? 'P' : 'B');

        const explanation = analyzeMoveLogic(move.num, isPlayer, pMoves, bMoves, available);
        
        const commBox = document.getElementById('comm-text');
        const color = isPlayer ? '#60a5fa' : '#f87171';
        const name = isPlayer ? 'Player' : 'Bot';
        
        commBox.innerHTML = `
            <div style="margin-bottom: 15px; border-left: 3px solid ${color}; padding-left: 10px;">
                <div style="color:${color}; font-weight:bold;">Move ${stepIndex + 1}: ${name} picks ${move.num}</div>
                <div>${explanation}</div>
            </div>
        ` + commBox.innerHTML;

        stepIndex++;
        if (stepIndex >= currentGame.moves.length) {
            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-next').style.opacity = "0.5";
            commBox.innerHTML = `<div style="color:var(--accent); font-weight:bold; margin-bottom:10px;">--- GAME OVER: ${currentGame.winner} ---</div>` + commBox.innerHTML;
        }
    }

    function analyzeMoveLogic(num, isPlayer, myMoves, oppMoves, pool) {
        if (checkWin(myMoves)) return "<strong>Victory!</strong> Completed a line of 15 (Tic-Tac-Toe line).";

        const neededToBlock = findWinningNumber(oppMoves, pool.concat([num]));
        if (neededToBlock === num) return "<strong>Critical Block!</strong> Opponent was about to win. Logic detected the threat.";

        if (num === 5) return "<strong>Center Control.</strong> 5 is the most valuable square (4 winning lines).";
        if ([2,4,6,8].includes(num)) return "<strong>Corner Strategy.</strong> Corners are strong (3 winning lines).";
        if ([1,3,7,9].includes(num)) return "<strong>Edge Move.</strong> Edges are weaker (2 lines) but can set traps.";

        return "Strategic placement to build towards 15.";
    }

    function findWinningNumber(moves, pool) {
        for (let i = 0; i < moves.length; i++) {
            for (let j = i + 1; j < moves.length; j++) {
                const needed = 15 - (moves[i] + moves[j]);
                if (pool.includes(needed)) return needed;
            }
        }
        return null;
    }

    function checkWin(moves) {
        if (moves.length < 3) return false;
        for (let i=0; i<moves.length; i++)
            for (let j=i+1; j<moves.length; j++)
                for (let k=j+1; k<moves.length; k++)
                    if (moves[i]+moves[j]+moves[k] === 15) return true;
        return false;
    }

</script>
</body>
</html>